name: Process RAP Tornado Data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_rap:
    runs-on: ubuntu-latest

    steps:

    # ---------------- Checkout ----------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ---------------- Python ----------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # ---------------- System deps ----------------
    - name: Install system libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gdal-bin \
          libgdal-dev \
          proj-bin \
          proj-data \
          libgeos-dev \
          libeccodes-dev \
          libatlas-base-dev \
          gfortran

    # ---------------- Python deps ----------------
    - name: Install Python packages
      run: |
        pip install --upgrade pip setuptools wheel

        pip install \
          pygrib \
          numpy \
          xarray \
          pillow \
          matplotlib \
          cartopy \
          shapely \
          pyproj \
          scipy \
          rasterio

    # ---------------- Run script ----------------
    - name: Run RAP processor
      run: |
        python scripts/process_rap.py

    # ---------------- Verify tiles ----------------
    - name: Verify tiles exist
      run: |
        echo "Listing tiles:"
        ls -R map/tiles | head -100

    # ---------------- Commit ----------------
    - name: Commit and push outputs
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        # Force add tiles even if ignored
        git add -f map/tiles
        git add map/data

        git status

        git commit -m "Update RAP tornado tiles" || echo "Nothing to commit"

        git push
