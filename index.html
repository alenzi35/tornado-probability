<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
    h1{text-align:center;margin:10px 0;}
    #map{height:650px;margin:10px;border-radius:8px;position:relative;}
    .leaflet-control.custom-control{background:white;padding:10px;border-radius:6px;box-shadow:0 0 6px rgba(0,0,0,0.3);font-size:14px;}
    .leaflet-control.custom-control button,.leaflet-control.custom-control #validTime{height:30px;line-height:30px;margin:4px 0;width:100%;cursor:pointer;text-align:center;}
    #backBtn{display:none;}
  </style>
</head>
<body>
<h1>Tornado Probability Project</h1>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([39.5,-98.35],4);
var CONUS_bounds=[[22,-128],[51.5,-64]];
map.setMaxBounds(CONUS_bounds); map.zoomControl.setPosition('topleft');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

var CustomControl = L.Control.extend({options:{position:'topleft'},onAdd:function(map){
  var container=L.DomUtil.create('div','leaflet-control custom-control');
  container.innerHTML=`<b>Lead Time</b><br><button id="lead1">1 Hour</button><button id="lead3">3 Hour</button><button id="lead6">6 Hour</button><hr><button id="toggleCells">Toggle Cells</button><button id="backBtn">← Back to Aggregates</button><div id="validTime">Valid time - 00:00–01:00</div>`;
  L.DomEvent.disableClickPropagation(container); return container;
}});
map.addControl(new CustomControl());

var aggregateLayer=L.layerGroup().addTo(map);
var normalLayer=L.layerGroup();
var cellsVisible=true,currentLeadTime=1;
var tornadoData=[];

function getColorNorm(x){if(x>0.8)return'#800026';if(x>0.6)return'#BD0026';if(x>0.4)return'#E31A1C';if(x>0.2)return'#FC4E2A';return'#FFEDA0';}
function updateValidTime(){let now=new Date(); let startHour=now.getUTCHours(); let endHour=(startHour+currentLeadTime)%24; document.getElementById('validTime').innerText=`Valid time - ${startHour.toString().padStart(2,'0')}:00–${endHour.toString().padStart(2,'0')}:00`;}
function setLeadTime(h){currentLeadTime=h; drawAggregates();}
function toggleCells(){cellsVisible=!cellsVisible; aggregateLayer.eachLayer(l=>{l.setStyle({fillOpacity:cellsVisible?0.6:0,weight:cellsVisible?1:0}); l.getElement().style.pointerEvents=cellsVisible?'auto':'none';}); normalLayer.eachLayer(l=>{l.setStyle({fillOpacity:cellsVisible?0.75:0,weight:cellsVisible?0.4:0}); l.getElement().style.pointerEvents=cellsVisible?'auto':'none';});}

function drawAggregates(){
  aggregateLayer.clearLayers(); normalLayer.clearLayers(); document.getElementById("backBtn").style.display="none";
  if(!tornadoData.length)return;
  let minP=Math.min(...tornadoData.map(a=>a.prob)),maxP=Math.max(...tornadoData.map(a=>a.prob));
  tornadoData.forEach(a=>{
    let norm=(a.prob-minP)/(maxP-minP+1e-9);
    let rect=L.rectangle([[a.lat,a.lng],[a.lat+1.18,a.lng+1.94]],{fillColor:getColorNorm(norm),fillOpacity:cellsVisible?0.6:0,color:"#000",weight:cellsVisible?1:0}).addTo(aggregateLayer);
    rect.bindPopup(`<b>Aggregate Probability</b><br>${(a.prob*100).toFixed(2)}%<br><br><i>Double-click to view 13 km cells</i>`);
    rect.on('dblclick',function(e){if(!cellsVisible)return; aggregateLayer.clearLayers(); drawNormalCells(e.target.getBounds()); document.getElementById("backBtn").style.display="block";});
  });
  updateValidTime();
}

function drawNormalCells(bounds){normalLayer.clearLayers(); let sw=bounds.getSouthWest(),ne=bounds.getNorthEast(),latS=(ne.lat-sw.lat)/10,lngS=(ne.lng-sw.lng)/10;
  for(let i=0;i<10;i++){for(let j=0;j<10;j++){let cellProb=0.0; L.rectangle([[sw.lat+i*latS,sw.lng+j*lngS],[sw.lat+(i+1)*latS,sw.lng+(j+1)*lngS]],{fillColor:getColorNorm(cellProb/0.006),fillOpacity:cellsVisible?0.75:0,color:"#000",weight:cellsVisible?0.4:0}).addTo(normalLayer);}}
  normalLayer.addTo(map); map.fitBounds(bounds);
}

// load JSON
fetch('data/tornado_prob.json').then(r=>r.json()).then(data=>{tornadoData=data; drawAggregates();}).catch(err=>console.error("Failed to load tornado_prob.json:",err));

document.getElementById('lead1').onclick=()=>setLeadTime(1);
document.getElementById('lead3').onclick=()=>setLeadTime(3);
document.getElementById('lead6').onclick=()=>setLeadTime(6);
document.getElementById('toggleCells').onclick=()=>toggleCells();
document.getElementById('backBtn').onclick=()=>drawAggregates();

</script>
</body>
</html>
