<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability Map - EPSG:2163</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 600px; margin: 20px; }
    h1, p { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Tornado Probability Project</h1>
  <p>If you can read this, GitHub Pages is working.</p>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- proj4 + proj4leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4/2.8.0/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

  <script>
    // ----------------------
    // Define EPSG:2163 CRS
    var crs = new L.Proj.CRS('EPSG:2163',
      '+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +units=m +no_defs',
      { resolutions: [8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1,0.5] }
    );

    // Initialize map with EPSG:2163 CRS
    var map = L.map('map', {
      crs: crs,
      minZoom: 2,
      maxZoom: 8
    }).setView([39.5, -98.35], 4);

    // Add OpenStreetMap tiles (Web Mercator)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // ----------------------
    // Layers
    var aggregateLayer = L.layerGroup().addTo(map);
    var normalLayer = L.layerGroup();

    // ----------------------
    // Placeholder probability and color functions
    function randomProb() {
      return (Math.random() * 0.002).toFixed(5);
    }

    function getColor(prob) {
      var p = parseFloat(prob);
      if (p > 0.0015) return '#800026';
      else if (p > 0.001) return '#BD0026';
      else if (p > 0.0005) return '#E31A1C';
      else if (p > 0.0002) return '#FC4E2A';
      else return '#FFEDA0';
    }

    // ----------------------
    // CONUS approximate bounds in meters (EPSG:2163)
    // These are approximate coordinates for SW/NE corners of CONUS
    var CONUS_sw = [-2360000, -2200000]; // x, y in meters
    var CONUS_ne = [2360000, 1900000];

    // ----------------------
    // Draw aggregate 130km cells
    var aggSize = 130000; // 130 km in meters
    for (var x = CONUS_sw[0]; x < CONUS_ne[0]; x += aggSize) {
      for (var y = CONUS_sw[1]; y < CONUS_ne[1]; y += aggSize) {
        var bounds = [[y, x], [y + aggSize, x + aggSize]]; // [southWest, northEast]
        L.rectangle(bounds, {color: "#0000FF", weight: 1, fillOpacity: 0.2})
          .addTo(aggregateLayer)
          .on('click', function(e) {
            aggregateLayer.clearLayers();
            drawNormalCells(e.target.getBounds());
          });
      }
    }

    // ----------------------
    // Draw normal 13km cells inside aggregate
    function drawNormalCells(aggregateBounds) {
      normalLayer.clearLayers();
      var x1 = aggregateBounds.getWest();
      var y1 = aggregateBounds.getSouth();
      var x2 = aggregateBounds.getEast();
      var y2 = aggregateBounds.getNorth();

      var cellSize = 13000; // 13 km in meters

      for (var xi = x1; xi < x2; xi += cellSize) {
        for (var yi = y1; yi < y2; yi += cellSize) {
          var cellBounds = [[yi, xi], [yi + cellSize, xi + cellSize]];
          var prob = randomProb();
          L.rectangle(cellBounds, {
            fillColor: getColor(prob),
            color: "#000",
            weight: 0.5,
            fillOpacity: 0.7
          }).bindPopup(`Probability: ${prob}`).addTo(normalLayer);
        }
      }

      normalLayer.addTo(map);
    }

  </script>
</body>
</html>
