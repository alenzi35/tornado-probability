<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; }
    #map { height:100vh; width:100%; }
    .leaflet-tooltip.custom {
      background:white;
      border:1px solid #333;
      border-radius:4px;
      padding:4px 6px;
      font-size:14px;
      color:#000;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const CONUS_BOUNDS = [[22, -125], [51, -66]];
const map = L.map('map', { minZoom:4, maxZoom:18, maxBounds:CONUS_BOUNDS, maxBoundsViscosity:0.5 })
  .setView([39.5, -98.35], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© OpenStreetMap contributors'
}).addTo(map);

const cellLayer = L.layerGroup().addTo(map);

// Load JSON
fetch("map/data/tornado_prob.json")
  .then(r => r.json())
  .then(jsonData => {
    
    // Fixed cell size in km
    const CELL_KM = 13.545;

    jsonData.forEach(pt => {
      // Compute rectangle size in degrees dynamically
      const latHeight = CELL_KM / 111.32; // ~km per degree latitude
      const lonWidth = CELL_KM / (111.32 * Math.cos(pt.lat * Math.PI/180));

      const bounds = [
        [pt.lat, pt.lon],
        [pt.lat + latHeight, pt.lon + lonWidth]
      ];

      // Only draw if inside CONUS
      if(bounds[0][0] > CONUS_BOUNDS[1][0] || bounds[1][0] < CONUS_BOUNDS[0][0] ||
         bounds[0][1] > CONUS_BOUNDS[1][1] || bounds[1][1] < CONUS_BOUNDS[0][1]) return;

      const rect = L.rectangle(bounds, {
        fillColor: getColor(pt.prob),
        fillOpacity:0.7,
        color:'#000',
        weight:0.3
      }).addTo(cellLayer);

      rect.bindTooltip(`Probability: ${pt.prob.toFixed(4)}`, {className:'custom', sticky:true});
    });

  })
  .catch(err => console.error("Failed to load JSON:", err));

// Color mapping
function getColor(p){
  if(p>0.8) return '#800026';
  if(p>0.6) return '#BD0026';
  if(p>0.4) return '#E31A1C';
  if(p>0.2) return '#FC4E2A';
  return '#FFEDA0';
}
</script>
</body>
</html>
