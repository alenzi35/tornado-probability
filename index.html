<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    h1, p { text-align: center; margin: 10px; }
    #map { height: 650px; margin: 10px; border-radius: 8px; }

    #backBtn {
      position: absolute;
      top: 90px;
      left: 20px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #999;
      border-radius: 4px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

<h1>Tornado Probability Project</h1>
<p>If you can read this, GitHub Pages is working.</p>

<div id="backBtn">← Back to aggregates</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // ------------------------------------
  // Expanded CONUS bounds (~8% padding)
  var CONUS_bounds = [[22, -128], [51.5, -64]];

  var map = L.map('map', {
    maxBounds: CONUS_bounds,
    maxBoundsViscosity: 0.8,
    minZoom: 4,
    maxZoom: 8
  }).setView([39.5, -98.35], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // ------------------------------------
  var aggregateLayer = L.layerGroup().addTo(map);
  var normalLayer = L.layerGroup();

  var backBtn = document.getElementById("backBtn");

  // ------------------------------------
  function randomProb() {
    return Math.random() * 0.002;
  }

  function getColor(p) {
    if (p > 0.01) return '#800026';
    if (p > 0.005) return '#BD0026';
    if (p > 0.002) return '#E31A1C';
    if (p > 0.001) return '#FC4E2A';
    return '#FFEDA0';
  }

  // ------------------------------------
  // Draw aggregate cells
  var latStep = 1.18;
  var lngStep = 1.94;

  function drawAggregates() {
    aggregateLayer.clearLayers();
    normalLayer.clearLayers();
    backBtn.style.display = "none";

    for (var lat = 24.5; lat < 49.5; lat += latStep) {
      for (var lng = -125; lng < -66.5; lng += lngStep) {

        // Remove far-east ocean-only column
        if (lng > -70) continue;

        let bounds = [[lat, lng], [lat + latStep, lng + lngStep]];

        // Precompute aggregate probability
        let probs = [];
        for (let i = 0; i < 100; i++) probs.push(randomProb());

        let aggProb = 1 - probs.reduce((acc, p) => acc * (1 - p), 1);

        let rect = L.rectangle(bounds, {
          fillColor: getColor(aggProb),
          color: "#333",
          weight: 1,
          fillOpacity: 0.6
        }).addTo(aggregateLayer);

        rect.bindPopup(
          `Aggregate Probability:<br><b>${aggProb.toFixed(4)}</b><br><small>Double-click to drill down</small>`
        );

        rect.on('dblclick', function(e) {
          aggregateLayer.clearLayers();
          drawNormalCells(e.target.getBounds());
          backBtn.style.display = "block";
        });
      }
    }
  }

  // ------------------------------------
  function drawNormalCells(aggregateBounds) {
    normalLayer.clearLayers();

    var sw = aggregateBounds.getSouthWest();
    var ne = aggregateBounds.getNorthEast();

    var latStepSmall = (ne.lat - sw.lat) / 10;
    var lngStepSmall = (ne.lng - sw.lng) / 10;

    for (var i = 0; i < 10; i++) {
      for (var j = 0; j < 10; j++) {
        var bounds = [
          [sw.lat + i * latStepSmall, sw.lng + j * lngStepSmall],
          [sw.lat + (i + 1) * latStepSmall, sw.lng + (j + 1) * lngStepSmall]
        ];

        let p = randomProb();

        L.rectangle(bounds, {
          fillColor: getColor(p),
          color: "#000",
          weight: 0.4,
          fillOpacity: 0.8
        }).bindPopup(`Cell Probability: ${p.toFixed(5)}`)
          .addTo(normalLayer);
      }
    }

    normalLayer.addTo(map);
    map.fitBounds(aggregateBounds);
  }

  // ------------------------------------
  backBtn.onclick = function() {
    drawAggregates();
  };

  // Initial draw
  drawAggregates();
</script>

</body>
</html>
