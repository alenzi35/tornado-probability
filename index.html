<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RAP Native Grid Viewer</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
  }
  canvas { display: block; }
</style>
</head>
<body>

<canvas id="map"></canvas>

<script>
const canvas = document.getElementById("map");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ================= DATA ================= */
let cells = [];
let bounds = null;

/* ================= CAMERA ================= */
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let dragging = false;
let lastX = 0;
let lastY = 0;

canvas.addEventListener("mousedown", e => {
  dragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
});
window.addEventListener("mouseup", () => dragging = false);
window.addEventListener("mousemove", e => {
  if (!dragging) return;
  offsetX += e.clientX - lastX;
  offsetY += e.clientY - lastY;
  lastX = e.clientX;
  lastY = e.clientY;
  draw();
});
canvas.addEventListener("wheel", e => {
  e.preventDefault();
  scale *= e.deltaY < 0 ? 1.1 : 0.9;
  draw();
});

/* ================= LOAD ================= */
fetch("map/data/tornado_prob.json")
  .then(r => r.json())
  .then(data => {
    cells = data;
    computeBounds();
    centerView();
    draw();
  })
  .catch(e => alert("JSON load failed: " + e));

/* ================= BOUNDS ================= */
function computeBounds() {
  let minX = Infinity, maxX = -Infinity;
  let minY = Infinity, maxY = -Infinity;

  for (const c of cells) {
    minX = Math.min(minX, c.lon_min);
    maxX = Math.max(maxX, c.lon_max);
    minY = Math.min(minY, c.lat_min);
    maxY = Math.max(maxY, c.lat_max);
  }

  bounds = { minX, maxX, minY, maxY };
}

/* ================= CENTER ================= */
function centerView() {
  const gridWidth = bounds.maxX - bounds.minX;
  const gridHeight = bounds.maxY - bounds.minY;

  const sx = canvas.width / gridWidth;
  const sy = canvas.height / gridHeight;
  scale = Math.min(sx, sy) * 0.9;

  offsetX = canvas.width / 2 - (bounds.minX + gridWidth / 2) * scale;
  offsetY = canvas.height / 2 + (bounds.minY + gridHeight / 2) * scale;
}

/* ================= DRAW ================= */
function draw() {
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.setTransform(scale, 0, 0, -scale, offsetX, offsetY);

  for (const c of cells) {
    const p = Math.max(0, Math.min(1, c.prob));
    ctx.fillStyle = `rgb(${255*p|0},0,${255*(1-p)|0})`;
    ctx.fillRect(
      c.lon_min,
      c.lat_min,
      c.lon_max - c.lon_min,
      c.lat_max - c.lat_min
    );
  }
}

/* ================= FALLBACK ================= */
ctx.fillStyle = "white";
ctx.font = "20px sans-serif";
ctx.fillText("Loading RAP gridâ€¦", 20, 30);
</script>
</body>
</html>
