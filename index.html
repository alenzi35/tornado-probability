<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>RAP Tornado Probability Map</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  body { margin:0; padding:0; }
  #map { width:100vw; height:100vh; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/proj4/dist/proj4.js"></script>

<script>
// ---------------- SETUP ----------------
const map = L.map('map').setView([39, -98], 4); // center on CONUS

// Add base tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 19
}).addTo(map);

// LCC → Mercator projection
const lcc = proj4(
  "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=253 +a=6371229 +b=6371229 +units=m +no_defs"
);
const mercator = proj4('EPSG:3857');

// ---------------- LOAD RAP JSON ----------------
fetch('map/data/tornado_prob_lcc.json')
  .then(res => res.json())
  .then(json => {
    const features = json.features;

    features.forEach(f => {
      // Compute four corners in LCC
      const cornersLCC = [
        [f.x - f.dx/2, f.y - f.dy/2],
        [f.x + f.dx/2, f.y - f.dy/2],
        [f.x + f.dx/2, f.y + f.dy/2],
        [f.x - f.dx/2, f.y + f.dy/2]
      ];

      // Project corners to lat/lon for Leaflet
      const cornersLatLon = cornersLCC.map(c => {
        const [mx, my] = proj4(lcc, mercator, c);
        // Leaflet uses lat/lon; proj4 EPSG:3857 → lat/lon
        return mercatorToLatLon(mx, my);
      });

      // Color based on probability
      const red = Math.floor(255 * f.prob);
      const blue = Math.floor(255 * (1 - f.prob));
      const color = `rgba(${red},0,${blue},0.6)`;

      // Add polygon to map
      const poly = L.polygon(cornersLatLon, {color: color, fillColor: color, weight: 0});
      poly.addTo(map);

      // Popup on hover
      poly.bindTooltip(`Prob: ${(f.prob*100).toFixed(1)}%`, {sticky:true});
    });
  });

// Convert Mercator (EPSG:3857) meters → lat/lon
function mercatorToLatLon(x, y){
  const lon = (x / 20037508.34) * 180;
  let lat = (y / 20037508.34) * 180;
  lat = 180/Math.PI*(2*Math.atan(Math.exp(lat*Math.PI/180))-Math.PI/2);
  return [lat, lon];
}
</script>
</body>
</html>
