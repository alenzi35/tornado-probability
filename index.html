<!DOCTYPE html>
<html>
<head>
  <title>RAP Grid Cell Size Measurement</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<h1>RAP Grid Cell Size Measurement</h1>
<div id="output"></div>

<script>
// Haversine formula to convert lat/lon differences to km
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth radius in km
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

fetch("map/data/tornado_prob.json")
  .then(resp => resp.json())
  .then(data => {
    if(data.length < 2) {
      document.getElementById('output').innerText = "Not enough points to measure spacing.";
      return;
    }

    let widths = [];
    let heights = [];

    data.forEach(p0 => {
      let nearestLat = null;
      let nearestLon = null;
      let minLatDiff = Infinity;
      let minLonDiff = Infinity;

      data.forEach(p => {
        if(p === p0) return;
        const latDiff = Math.abs(p.lat - p0.lat);
        const lonDiff = Math.abs(p.lon - p0.lon);

        if(latDiff > 0 && latDiff < minLatDiff) { minLatDiff = latDiff; nearestLat = p; }
        if(lonDiff > 0 && lonDiff < minLonDiff) { minLonDiff = lonDiff; nearestLon = p; }
      });

      if(nearestLat) {
        heights.push(haversine(p0.lat, p0.lon, nearestLat.lat, p0.lon));
      }
      if(nearestLon) {
        widths.push(haversine(p0.lat, p0.lon, p0.lat, nearestLon.lon));
      }
    });

    const avgWidth = widths.reduce((a,b)=>a+b,0)/widths.length;
    const avgHeight = heights.reduce((a,b)=>a+b,0)/heights.length;

    const output = `
      Approximate RAP grid cell size:<br>
      Width ≈ ${avgWidth.toFixed(3)} km<br>
      Height ≈ ${avgHeight.toFixed(3)} km
    `;

    document.getElementById('output').innerHTML = output;
    console.log("Approx RAP cell size:", avgWidth.toFixed(3), "km ×", avgHeight.toFixed(3), "km");
  })
  .catch(err => {
    console.error("Failed to load JSON:", err);
    document.getElementById('output').innerText = "Failed to load JSON.";
  });
</script>

</body>
</html>
