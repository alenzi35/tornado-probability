<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      background: #0b0f14;
      color: #eaeaea;
      font-family: system-ui, sans-serif;
    }

    #map {
      height: 85vh;
      width: 100%;
    }

    #toolbar {
      padding: 10px;
      background: #121821;
      border-bottom: 1px solid #1f2a38;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    button {
      background: #1f2a38;
      color: #fff;
      border: 1px solid #2e3f55;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>

<body>

<div id="toolbar">
  <button id="backBtn" disabled>Back</button>
  <span>EPSG:2163 Â· True 13 km Grid</span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4/2.8.0/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

<script>
/* =========================
   PROJECTION
========================= */

const crs = new L.Proj.CRS(
  "EPSG:2163",
  "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +units=m +no_defs",
  { resolutions: [8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1] }
);

/* =========================
   MAP
========================= */

const map = L.map("map", {
  crs,
  minZoom: 2,
  maxZoom: 8
});

/* =========================
   LAYERS
========================= */

const aggregateLayer = L.layerGroup().addTo(map);
const cellLayer = L.layerGroup().addTo(map);

/* =========================
   CONSTANTS
========================= */

const CELL = 13000;
const AGG  = 130000;

const CONUS_SW = [-2600000, -2400000];
const CONUS_NE = [ 2600000,  2100000];

const EAST_CUTOFF = 1600000;

map.fitBounds([
  [CONUS_SW[1], CONUS_SW[0]],
  [CONUS_NE[1], CONUS_NE[0]]
]);

/* =========================
   UTIL
========================= */

function randProb() {
  return Math.random() * 0.002;
}

function color(p) {
  if (p > 0.0015) return "#800026";
  if (p > 0.0010) return "#BD0026";
  if (p > 0.0005) return "#E31A1C";
  if (p > 0.0002) return "#FC4E2A";
  return "#FFEDA0";
}

/* =========================
   STATE
========================= */

let view = "aggregate";
const backBtn = document.getElementById("backBtn");

/* =========================
   AGGREGATES
========================= */

function drawAggregates() {
  aggregateLayer.clearLayers();
  cellLayer.clearLayers();
  view = "aggregate";
  backBtn.disabled = true;

  for (let x = CONUS_SW[0]; x < CONUS_NE[0]; x += AGG) {
    if (x > EAST_CUTOFF) continue;

    for (let y = CONUS_SW[1]; y < CONUS_NE[1]; y += AGG) {

      const probs = Array.from({length:100}, randProb);
      const mean = probs.reduce((a,b)=>a+b,0) / probs.length;

      const bounds = [
        [y, x],
        [y + AGG, x + AGG]
      ];

      new L.Proj.Rectangle(bounds, {
        fillColor: color(mean),
        fillOpacity: 0.7,
        color: "#111",
        weight: 1
      })
      .on("click", () => drawCells(bounds))
      .addTo(aggregateLayer);
    }
  }
}

/* =========================
   CELLS
========================= */

function drawCells(bounds) {
  aggregateLayer.clearLayers();
  cellLayer.clearLayers();
  view = "cells";
  backBtn.disabled = false;

  const west  = bounds[0][1];
  const south = bounds[0][0];
  const east  = bounds[1][1];
  const north = bounds[1][0];

  for (let x = west; x < east; x += CELL) {
    for (let y = south; y < north; y += CELL) {

      const p = randProb();

      new L.Proj.Rectangle(
        [[y, x], [y + CELL, x + CELL]],
        {
          fillColor: color(p),
          fillOpacity: 0.85,
          color: "#000",
          weight: 0.4
        }
      )
      .bindPopup(`<b>${(p*100).toFixed(4)}%</b>`)
      .addTo(cellLayer);
    }
  }
}

/* =========================
   BACK
========================= */

backBtn.onclick = () => {
  if (view === "cells") drawAggregates();
};

/* =========================
   START
========================= */

drawAggregates();

</script>
</body>
</html>
