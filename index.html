<!DOCTYPE html>
<html>
<head>
  <title>Tornado Probability Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    h1, p { text-align: center; margin: 10px; }
    #map { height: 650px; margin: 10px; border-radius: 8px; }

    #backBtn {
      position: absolute;
      top: 90px;
      left: 20px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #999;
      border-radius: 4px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

<h1>Tornado Probability Project</h1>
<p>If you can read this, GitHub Pages is working.</p>

<div id="backBtn">‚Üê Back to aggregates</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // ------------------------------------
  var CONUS_bounds = [[22, -128], [51.5, -64]];

  var map = L.map('map', {
    maxBounds: CONUS_bounds,
    maxBoundsViscosity: 0.8,
    minZoom: 4,
    maxZoom: 18   // üîß RESTORED STREET-LEVEL ZOOM
  }).setView([39.5, -98.35], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  var aggregateLayer = L.layerGroup().addTo(map);
  var normalLayer = L.layerGroup();
  var backBtn = document.getElementById("backBtn");

  function randomProb() {
    return Math.random() * 0.002;
  }

  function getColorNorm(x) {
    if (x > 0.8) return '#800026';
    if (x > 0.6) return '#BD0026';
    if (x > 0.4) return '#E31A1C';
    if (x > 0.2) return '#FC4E2A';
    return '#FFEDA0';
  }

  var latStep = 1.18;
  var lngStep = 1.94;

  function drawAggregates() {
    aggregateLayer.clearLayers();
    normalLayer.clearLayers();
    backBtn.style.display = "none";

    let aggregates = [];

    // ---- First pass: compute probabilities
    for (let lat = 24.5; lat < 49.5; lat += latStep) {
      for (let lng = -125; lng < -66.5; lng += lngStep) {

        // üîß FIXED east cutoff (only remove 1 column)
        if (lng > -68) continue;

        let probs = [];
        for (let i = 0; i < 100; i++) probs.push(randomProb());

        let aggProb = 1 - probs.reduce((a, p) => a * (1 - p), 1);

        aggregates.push({ lat, lng, aggProb });
      }
    }

    let minP = Math.min(...aggregates.map(a => a.aggProb));
    let maxP = Math.max(...aggregates.map(a => a.aggProb));

    // ---- Second pass: draw
    aggregates.forEach(a => {
      let norm = (a.aggProb - minP) / (maxP - minP + 1e-9);

      let bounds = [
        [a.lat, a.lng],
        [a.lat + latStep, a.lng + lngStep]
      ];

      let rect = L.rectangle(bounds, {
        fillColor: getColorNorm(norm),
        color: "#333",
        weight: 1,
        fillOpacity: 0.65
      }).addTo(aggregateLayer);

      rect.bindPopup(
        `Aggregate Probability:<br><b>${a.aggProb.toFixed(4)}</b><br><small>Double-click to drill down</small>`
      );

      rect.on('dblclick', function(e) {
        aggregateLayer.clearLayers();
        drawNormalCells(e.target.getBounds());
        backBtn.style.display = "block";
      });
    });
  }

  function drawNormalCells(bounds) {
    normalLayer.clearLayers();

    let sw = bounds.getSouthWest();
    let ne = bounds.getNorthEast();

    let latS = (ne.lat - sw.lat) / 10;
    let lngS = (ne.lng - sw.lng) / 10;

    for (let i = 0; i < 10; i++) {
      for (let j = 0; j < 10; j++) {
        let cell = [
          [sw.lat + i * latS, sw.lng + j * lngS],
          [sw.lat + (i + 1) * latS, sw.lng + (j + 1) * lngS]
        ];

        let p = randomProb();

        L.rectangle(cell, {
          fillColor: getColorNorm(p / 0.002),
          color: "#000",
          weight: 0.4,
          fillOpacity: 0.8
        }).bindPopup(`Cell Probability: ${p.toFixed(5)}`)
          .addTo(normalLayer);
      }
    }

    normalLayer.addTo(map);
    map.fitBounds(bounds);
  }

  backBtn.onclick = drawAggregates;

  drawAggregates();
</script>

</body>
</html>
